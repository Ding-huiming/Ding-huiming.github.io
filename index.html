<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Comparison</title>
    <style type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        ul, li {
            list-style: none;
        }

        a {
            text-decoration: none;
        }

        input {
            outline-style: none;
            border: 0px;
        }

        #form1 {
            margin-top: 20px;
            width: 80%;
            margin: 2px auto;
        }

        #form1 form span {
            color: #999;
        }

        .row {
            margin-top: 25px;
            height: 50px;
            line-height: 26px;
            border-bottom: 1px solid #c7c6c6;
            width: 100%;
        }

        .input {
            position: relative;
            width: 100%;
            height: 26px;
        }

        .input input {
            display: block;
            width: 100%;
            height: 26px;
            border: none;
            background: none;
            outline: none;
        }

        .input label {
            position: absolute;
            top: 0;
            left: 0;
            height: 26px;
            line-height: 26px;
            font-size: 14px;
            color: #999;
        }

        .select select {
            display: block;
            width: 100%;
            border: none;
            outline: none;
        }

        input[type=date]::-webkit-inner-spin-button {
            visibility: hidden;
        }

        .button {
            width: 100%;
            height: 40px;
            background: #ff961e;
            outline: none;
            margin: 20px 0 30px 0;
        }

        .button button {
            border: 0px;
            background-color: transparent;
            color: white;
            width: 100%;
            height: 40px;
            margin: 0 auto;
            font-size: 17px;
        }

        .buttonphoto {
            width: 100%;
            height: 40px;
            background: gray;
            outline: none;
            margin: 20px 0;
        }

        .buttonphoto button {
            border: 0px;
            background-color: transparent;
            color: white;
            width: 100%;
            height: 40px;
            margin: 0 auto;
            font-size: 17px;
        }

        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .quote {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="form1">
        <div class="row">
            <label for="studentId">学号</label>
            <input type="text" id="studentId" value="2019304010110" readonly>
        </div>
        <div class="row">
            <label for="name">姓名</label>
            <input type="text" id="name" value="丁慧明" readonly>
        </div>
        <div class="row">
            <p>因签到需要，请允许获取您的位置</p>
        </div>
        <div>
            <input type="file" accept="image/*" capture="camera" id="image2Input" style="display:none;" onchange="readFile(this)">
            <div class="buttonphoto">
                <button type="button" onclick="document.getElementById('image2Input').click()">请自拍您和现场照</button>
            </div>
            <img id="image2" src="" alt="Image 2" width="200">
        </div>
        <div class="button">
            <button type="submit" onclick="initrun()" id="submitinitrun">点我后才能签到</button>
        </div>
    </div>
    <div class="quote">
        <p>业精于勤，荒于嬉。---韩愈</p>
    </div>

    <!-- 引入 face-api.js 库 -->
    <script src="dist/face-api.min.js"></script>
    <script>
        faceapi.loadSsdMobilenetv1Model('/weights')
            .then(() => faceapi.loadFaceLandmarkModel('/weights'))
            .then(() => faceapi.loadFaceRecognitionModel('/weights'))
            .then(() => {
                console.log('模型加载完成！');
                processPredefinedImage();
            })
            .catch(error => {
                console.error('加载模型时出现错误：', error);
            });

        var descriptors = [];

        function processPredefinedImage() {
            const predefinedImagePath = 'q3.jpg';
            const imageElement = new Image();
            imageElement.src = predefinedImagePath;
            imageElement.onload = function() {
                faceapi.detectSingleFace(imageElement).withFaceLandmarks().withFaceDescriptor()
                    .then(detection => {
                        if (detection) {
                            descriptors.push(detection.descriptor);
                            console.log('Predefined image processed and descriptor saved:', descriptors);
                        } else {
                            console.error('No face detected in the predefined image');
                        }
                    })
                    .catch(error => {
                        console.error('Error detecting face in predefined image:', error);
                    });
            }
        }

        function readFile(obj) {
            var file = obj.files[0];
            if (!/image\/\w+/.test(file.type)) {
                alert("请确保文件为图像类型");
                return false;
            }
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                dealImage(this.result, { width: 600 }, function(base) {
                    document.getElementById('image2').setAttribute('src', base);
                    const imageElement = new Image();
                    imageElement.src = base;
                    processImage(imageElement);
                    document.getElementById('image2').setAttribute('width', "200");
                });
            }
        }

        function processImage(imageElement) {
            return new Promise((resolve, reject) => {
                faceapi.detectSingleFace(imageElement).withFaceLandmarks().withFaceDescriptor()
                    .then(detection => {
                        if (detection) {
                            descriptors.push(detection.descriptor);
                            console.log('Face detected and descriptor saved:', descriptors);
                        } else {
                            console.error('No face detected in the uploaded image');
                        }
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error detecting face:', error);
                        reject(error);
                    });
            });
        }

        function dealImage(path, obj, callback) {
            var img = new Image();
            img.src = path;
            img.onload = function() {
                var that = this;
                var w = that.width,
                    h = that.height,
                    scale = w / h;
                w = obj.width || w;
                h = obj.height || (w / scale);
                var quality = 0.7;
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var anw = document.createAttribute("width");
                anw.nodeValue = w;
                var anh = document.createAttribute("height");
                anh.nodeValue = h;
                canvas.setAttributeNode(anw);
                canvas.setAttributeNode(anh);
                ctx.drawImage(that, 0, 0, w, h);
                if (obj.quality && obj.quality <= 1 && obj.quality > 0) {
                    quality = obj.quality;
                }
                var base64 = canvas.toDataURL('image/jpeg', quality);
                callback(base64);
            };
        }

        function initrun() {
            if (descriptors.length >= 2) {
                const similarity = 1 - faceapi.euclideanDistance(descriptors[0], descriptors[1]);
                console.log('Similarity:', similarity);
                alert('相似度：' + similarity.toFixed(4));
                if (similarity >= 0.6) {
                    descriptors = [];
                    return true;
                } else {
                    alert("请重新拍照上传图片，以确保清晰度和准确性。");
                    descriptors.pop();
                    return false;
                }
            } else {
                alert("请先拍照上传图片。");
                return false;
            }
        }
    </script>
</body>
</html>
